server:
  port: 8080

spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
      routes:
        # ---------------------------------------------------
        # 1. NEW: Route for Login/Register (Public)
        # ---------------------------------------------------
        - id: user-service-auth
          uri: lb://USER-SERVICE
          predicates:
            - Path=/auth/** # <--- Matches /auth/login
          # Notice: NO AuthFilter here! (Login must be public)

        # ---------------------------------------------------
        # 2. Existing Route for Profile (Protected)
        # ---------------------------------------------------
        - id: user-service-protected
          uri: lb://USER-SERVICE
          predicates:
            - Path=/users/**
          filters:
            - name: AuthFilter
              args:
                requiredRole: USER

        # ---------------------------------------------------
        # 3. Order Service Admin Routes (ADMIN only)
        # NOTE: This MUST come BEFORE the general /admin/** route
        # ---------------------------------------------------
        - id: order-service-admin
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/admin/orders/**
            - Method=GET, OPTIONS
          filters:
            - name: AuthFilter
              args:
                requiredRole: ADMIN

        # ---------------------------------------------------
        # 4. User Service Admin Analytics Route (ADMIN only)
        # ---------------------------------------------------
        - id: user-service-admin
          uri: lb://USER-SERVICE
          predicates:
            - Path=/admin/users/**
            - Method=GET, OPTIONS
          filters:
            - name: AuthFilter
              args:
                requiredRole: ADMIN

        # --- Route A: Public Read Access (GET) ---
        # "Anyone can browse products"
        - id: product-service-read
          uri: lb://PRODUCT-SERVICE
          predicates:
            - Path=/api/v1/products/**, /api/v1/categories/**, /api/v1/images/**
            - Method=GET, OPTIONS

        # --- Route B: Admin Write Access (POST, PUT, DELETE) ---
        # "Only Admins can change data"
        # Your Java Filter (AuthenticationFilter) will run before this to validate the user
        - id: product-service-write
          uri: lb://PRODUCT-SERVICE
          predicates:
            - Path=/api/v1/products/**, /api/v1/categories/**, /api/v1/images/**
            - Method=POST, PUT, DELETE, OPTIONS
          filters:
            - name: AuthFilter        # <--- Matches your Java Class Name
              args:
                requiredRole: ADMIN,USER

        ## This is all related to the Inventory Service

        # --- Route C: Public Read Access (GET) ---
        # "Anyone can browse inventory"
        - id: inventory-service-read
          uri: lb://INVENTORY-SERVICE
          predicates:
            - Path=/api/v1/inventory/**
            - Method=GET, OPTIONS

        - id: inventory-service-write
          uri: lb://INVENTORY-SERVICE
          predicates:
            - Path=/api/v1/inventory/**
            - Method=POST, PUT, DELETE, PATCH, OPTIONS
          filters:
            - name: AuthFilter        # <--- Matches your Java Class Name
              args:
                requiredRole: ADMIN,USER
        # ---------------------------------------------------
        # 5. Search Service (Public / No Auth)
        # ---------------------------------------------------
        - id: search-service
          uri: lb://SEARCH-SERVICE
          predicates:
              - Path=/api/v1/search/**
              - Method=GET,DELETE,OPTIONS
      # No filters needed because search is public for everyone
        #This one is allowed to the admin
        - id: cart-service-write
          uri: lb://CART-SERVICE
          predicates:
            - Path=/api/v1/cart/**
            - Method=POST, PUT, DELETE, PATCH, GET, OPTIONS
          filters:
            - name: AuthFilter        # <--- Matches your Java Class Name
              args:
                requiredRole: USER
        - id: checkout-service-write
          uri: lb://CHECKOUT-SERVICE
          predicates:
            - Path=/api/checkout/**
            - Method=POST, PUT, DELETE, PATCH, GET, OPTIONS
          filters:
            - name: AuthFilter        # <--- Matches your Java Class Name
              args:
                requiredRole: USER

        - id: payment-service
          uri: lb://PAYMENT-SERVICE
          predicates:
            - Path=/api/payments/**
            - Method=POST, PUT, DELETE, PATCH, GET, OPTIONS

        - id: payment-webhooks
          uri: lb://PAYMENT-SERVICE
          predicates:
            - Path=/api/webhooks/**
            - Method=POST, OPTIONS

        - id: order-service
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/api/orders/**
            - Method=POST, PUT, DELETE, PATCH, GET, OPTIONS

        # ---------------------------------------------------
        # Wishlist Service Routes (Protected - USER role)
        # ---------------------------------------------------
        - id: wishlist-service-ping
          uri: lb://WISHLIST-SERVICE
          predicates:
            - Path=/api/v1/wishlist/ping
            - Method=GET, OPTIONS
          # No auth filter - public health check endpoint

        - id: wishlist-service
          uri: lb://WISHLIST-SERVICE
          predicates:
            - Path=/api/v1/wishlist/**
            - Method=POST, PUT, DELETE, PATCH, GET, OPTIONS
          filters:
            - name: AuthFilter
              args:
                requiredRole: USER

        # ---------------------------------------------------
        # Rating Service Routes
        # ---------------------------------------------------
        # Public endpoints - view product ratings
        - id: rating-service-read
          uri: lb://RATING-SERVICE
          predicates:
            - Path=/api/v1/ratings/product/**
            - Method=GET, OPTIONS

        # Protected endpoints - create/update/delete ratings
        - id: rating-service-write
          uri: lb://RATING-SERVICE
          predicates:
            - Path=/api/v1/ratings/**
            - Method=POST, PUT, DELETE, PATCH, GET, OPTIONS
          filters:
            - name: AuthFilter
              args:
                requiredRole: USER




#          filters:
#            - name: AuthFilter        # <--- Matches your Java Class Name
#              args:
#                requiredRole: USER

eureka:
  instance:
    prefer-ip-address: true
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/

logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive: DEBUG